name: Generate LineageOS Device Tree (dumpyara + aospdtgen)

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      FIRMWARE_URL:
        description: 'Direct URL to firmware zip (stock ROM)'
        required: true
      DEVICE_CODENAME:
        description: 'Device codename (e.g., X659B)'
        required: true
      BRAND:
        description: 'Device brand (e.g., infinix)'
        required: true
      MODEL:
        description: 'Device model (e.g., Infinix Hot 10i)'
        required: true

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Install system dependencies
      run: |
        sudo apt update
        sudo apt install -y python3 python3-pip wget aria2 unzip lz4 brotli p7zip-full \
          simg2img android-sdk-libsparse-utils \
          erofs-utils   # EROFS support ke liye (super.img ke liye)

    - name: Clone and install dumpyara
      run: |
        git clone https://github.com/sebaubuntu-python/dumpyara.git
        cd dumpyara
        pip install -e .
        cd ..

    - name: Clone and install aospdtgen
      run: |
        git clone https://github.com/sebaubuntu-python/aospdtgen.git
        cd aospdtgen
        pip install -e .
        cd ..

    - name: Download firmware
      run: |
        aria2c -x 16 -s 16 -o firmware.zip "${{ github.event.inputs.FIRMWARE_URL }}"

    # ⚠️ IMPORTANT: Directly use firmware.zip with dumpyara, no manual extraction
    - name: Run dumpyara to create system dump
      run: |
        mkdir -p dumpyara_output
        python -m dumpyara firmware.zip -o dumpyara_output/

    - name: Run aospdtgen on the dump
      run: |
        mkdir -p device_tree
        python -m aospdtgen dumpyara_output/ -o device_tree/

    - name: Package device tree
      run: |
        mkdir -p final/device/${{ github.event.inputs.BRAND }}/${{ github.event.inputs.DEVICE_CODENAME }}
        cp -r device_tree/* final/device/${{ github.event.inputs.BRAND }}/${{ github.event.inputs.DEVICE_CODENAME }}/ 2>/dev/null || true
        cd final
        tar -czf ../lineage_device_tree_${{ github.event.inputs.DEVICE_CODENAME }}.tar.gz *
        cd ..

    - name: Upload to Release
      uses: softprops/action-gh-release@v2
      with:
        files: lineage_device_tree_*.tar.gz
        name: "LineageOS Device Tree for ${{ github.event.inputs.DEVICE_CODENAME }}"
        tag_name: dt_${{ github.run_id }}
        body: |
          Device tree generated using **dumpyara + aospdtgen**.
          **Device:** ${{ github.event.inputs.MODEL }} (${{ github.event.inputs.DEVICE_CODENAME }})
          **⚠️ Auto-generated – manual fixes required:** Kernel source, proprietary blobs verification, HALs, etc.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
