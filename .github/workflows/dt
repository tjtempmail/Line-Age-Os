name: Generate LineageOS Device Tree using dumpyara + aospdtgen

permissions:
  contents: write
  actions: read
  checks: read
  pull-requests: read
  statuses: read

on:
  workflow_dispatch:
    inputs:
      FIRMWARE_URL:
        description: 'Direct URL to firmware zip (stock ROM)'
        required: true
      DEVICE_CODENAME:
        description: 'Device codename (e.g., surya, joyeuse)'
        required: true
      BRAND:
        description: 'Device brand (e.g., xiaomi, samsung)'
        required: true
      MODEL:
        description: 'Device model (e.g., Redmi Note 9 Pro)'
        required: true

jobs:
  generate-device-tree:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y python3 python3-pip python3-venv wget aria2 \
          unzip lz4 brotli p7zip-full simg2img img2simg \
          android-sdk-libsparse-utils
        pip3 install --upgrade pip

    - name: Clone and setup dumpyara
      run: |
        git clone https://github.com/sebaubuntu-python/dumpyara.git
        cd dumpyara
        python3 -m venv venv
        source venv/bin/activate
        pip install -r requirements.txt
        # Keep venv activated for next steps
        echo "source dumpyara/venv/bin/activate" >> $GITHUB_ENV

    - name: Clone and setup aospdtgen
      run: |
        git clone https://github.com/sebaubuntu-python/aospdtgen.git
        cd aospdtgen
        python3 -m venv venv
        source venv/bin/activate
        pip install -r requirements.txt
        # Ye baad me use hoga
        echo "source aospdtgen/venv/bin/activate" >> $GITHUB_ENV_2

    - name: Download firmware
      run: |
        aria2c -x 16 -s 16 -o firmware.zip "${{ github.event.inputs.FIRMWARE_URL }}"
        echo "Downloaded firmware:"
        ls -lh firmware.zip

    - name: Extract firmware and create dump with dumpyara
      run: |
        source dumpyara/venv/bin/activate
        
        # Create working directory
        mkdir -p working_dir
        
        # First extract all images from firmware.zip
        cd working_dir
        
        # Handle different firmware types (simplified - dumpyara can handle raw images)
        if [[ "${{ github.event.inputs.FIRMWARE_URL }}" == *"miui"* ]] || unzip -l ../firmware.zip 2>/dev/null | grep -q "payload.bin"; then
          echo "ðŸ“¦ Xiaomi ROM detected - extracting payload.bin"
          unzip ../firmware.zip "payload.bin" -d .
          git clone https://github.com/cyxx/extract_android_ota_payload.git
          cd extract_android_ota_payload
          python3 extract_android_ota_payload.py ../payload.bin ../images/
          cd ..
          mv images/* ./
        else
          # Try to extract all .img files
          unzip ../firmware.zip "*.img" -d . || 7z x ../firmware.zip -o. -y
        fi
        
        cd ..
        
        # Now run dumpyara on the extracted images
        echo "ðŸ”„ Running dumpyara to create system dump..."
        cd dumpyara
        source venv/bin/activate
        
        # Create output directory for dump
        mkdir -p ../dumpyara_output
        
        # dumpyara extracts and organizes all partitions
        python dumpyara.py ../working_dir --output ../dumpyara_output
        
        cd ..
        
        echo "âœ… dumpyara completed. Output structure:"
        ls -la dumpyara_output/

    - name: Run aospdtgen on the dump
      run: |
        source aospdtgen/venv/bin/activate
        
        # Verify dump structure
        if [ ! -d "dumpyara_output" ]; then
          echo "âŒ dumpyara_output not found!"
          exit 1
        fi
        
        # Create output directory for device tree
        mkdir -p device_tree_output
        
        # Run aospdtgen on the dump created by dumpyara
        echo "ðŸ”„ Running aospdtgen on dumpyara output..."
        cd aospdtgen
        source venv/bin/activate
        
        python -m aospdtgen ../dumpyara_output -o ../device_tree_output
        
        cd ..
        
        echo "âœ… aospdtgen completed. Device tree generated at:"
        ls -la device_tree_output/

    - name: Organize and package device tree
      run: |
        # Create proper device path structure
        DEVICE_PATH="${{ github.event.inputs.BRAND }}/${{ github.event.inputs.DEVICE_CODENAME }}"
        mkdir -p final_device_tree/device/$DEVICE_PATH
        
        # Copy generated files
        if [ -d "device_tree_output" ]; then
          cp -r device_tree_output/* final_device_tree/device/$DEVICE_PATH/ 2>/dev/null || true
        fi
        
        # Add comprehensive README
        cat > final_device_tree/README.md << 'EOF'
        # LineageOS Device Tree for ${{ github.event.inputs.MODEL }}
        
        ## ðŸ“± Device Information
        - **Device:** ${{ github.event.inputs.MODEL }}
        - **Codename:** ${{ github.event.inputs.DEVICE_CODENAME }}
        - **Brand:** ${{ github.event.inputs.BRAND }}
        
        ## ðŸ¤– Generation Method
        This device tree was generated using the official toolchain:
        1. **[dumpyara](https://github.com/sebaubuntu-python/dumpyara)** - Created complete system dump from stock ROM
        2. **[aospdtgen](https://github.com/sebaubuntu-python/aospdtgen)** - Generated LineageOS-compatible device tree
        
        ## ðŸ“¦ What's Included
        âœ… Complete partition information
        âœ… Proprietary blobs list (`proprietary-files.txt`)
        âœ… Vendor blobs tree
        âœ… BoardConfig.mk with detected values
        âœ… AndroidProducts.mk
        âœ… Device.mk with basic configuration
        âœ… extract-files.sh script
        âœ… setup-makefiles.sh
        
        ## ðŸ”§ Manual Fixes Required
        You MUST fix the following:
        
        ### 1. Kernel Source
        In `BoardConfig.mk`, update these lines:
        ```makefile
        TARGET_KERNEL_SOURCE := kernel/${{ github.event.inputs.BRAND }}/${{ github.event.inputs.DEVICE_CODENAME }}
        TARGET_KERNEL_CONFIG := your_device_defconfig
        ```
        
        ### 2. Proprietary Blobs
        Run from your device:
        ```bash
        cd device/${{ github.event.inputs.BRAND }}/${{ github.event.inputs.DEVICE_CODENAME }}
        ./extract-files.sh
        ```
        
        ### 3. Verify Partition Sizes
        Check `BoardConfig.mk` for correct:
        - `BOARD_SYSTEMIMAGE_PARTITION_SIZE`
        - `BOARD_VENDORIMAGE_PARTITION_SIZE`
        - `BOARD_BOOTIMAGE_PARTITION_SIZE`
        
        ### 4. Device Features
        Add HALs for:
        - Camera
        - Sensors
        - Lights
        - Audio
        - GPS
        
        ### 5. SELinux Policies
        Update `sepolicy` directory with device-specific rules.
        
        ## ðŸš€ How to Build
        1. Clone this tree to `device/${{ github.event.inputs.BRAND }}/${{ github.event.inputs.DEVICE_CODENAME }}`
        2. Clone kernel source to `kernel/${{ github.event.inputs.BRAND }}/${{ github.event.inputs.DEVICE_CODENAME }}`
        3. Setup LineageOS build environment
        4. Run `breakfast ${{ github.event.inputs.DEVICE_CODENAME }}`
        5. Run `brunch ${{ github.event.inputs.DEVICE_CODENAME }}`
        
        ## âš ï¸ Disclaimer
        This is an **auto-generated tree** and requires significant manual work to become fully functional. Use as a starting point only!
        EOF
        
        # Create final archive
        cd final_device_tree
        tar -czf ../lineage_device_tree_${{ github.event.inputs.DEVICE_CODENAME }}.tar.gz *
        cd ..
        
        echo "âœ… Final package created: lineage_device_tree_${{ github.event.inputs.DEVICE_CODENAME }}.tar.gz"

    - name: Upload to Release
      uses: softprops/action-gh-release@v2
      with:
        files: lineage_device_tree_*.tar.gz
        name: "LineageOS Device Tree for ${{ github.event.inputs.DEVICE_CODENAME }} (dumpyara+aospdtgen)"
        tag_name: aospdtgen_${{ github.run_id }}
        body: |
          ## ðŸŽ¯ LineageOS Device Tree generated with **dumpyara + aospdtgen**
          
          ### ðŸ“± Device: ${{ github.event.inputs.MODEL }} (${{ github.event.inputs.DEVICE_CODENAME }})
          
          ### âœ… What's included:
          - Complete partition structure from stock ROM
          - All proprietary blobs detected
          - Vendor tree with extracted files
          - Basic configuration files
          - extract-files.sh and setup-makefiles.sh scripts
          
          ### âŒ Manual fixes needed:
          1. **Kernel source** - Add correct kernel repo and defconfig
          2. **Run extract-files.sh** from actual device to get latest blobs
          3. **Verify all partition sizes** in BoardConfig.mk
          4. **Add device-specific HALs** (camera, sensors, etc.)
          5. **Fix SELinux policies**
          
          ### ðŸ“¦ How to use:
          1. Download and extract `lineage_device_tree_${{ github.event.inputs.DEVICE_CODENAME }}.tar.gz`
          2. Copy contents to `device/${{ github.event.inputs.BRAND }}/${{ github.event.inputs.DEVICE_CODENAME }}`
          3. Clone kernel source to `kernel/${{ github.event.inputs.BRAND }}/${{ github.event.inputs.DEVICE_CODENAME }}`
          4. Follow the detailed instructions in README.md
          
          **Note:** This is an auto-generated starting point - expect build errors that need manual fixes!
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
